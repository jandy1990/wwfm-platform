# Testing Quick Reference

## âš ï¸ CRITICAL: Pre-Flight Checklist

**ALWAYS run this before testing:**
```bash
npm run test:db:verify
```

This automated script checks:
- âœ… No existing dev servers (kills them if found)
- âœ… Port 3000 is free
- âœ… Next.js cache is cleared
- âœ… Supabase is running
- âœ… Database has complete reference data (arenas, categories, goals)
- âœ… Test fixtures exist (23 solutions)
- âœ… Test user exists and is confirmed

**If verification fails, it provides specific fix commands.**

---

## ðŸš€ Essential Commands

```bash
# Tiered Testing (fastest to comprehensive)
npm run test:smoke        # 6 tests, ~30 seconds
npm run test:critical     # 34 tests, ~5 minutes
npm run test:forms:local  # Chromium + disposable Supabase
npm run test:forms        # Legacy all projects (Supabase must be running)

# Run specific form
npm run test:forms -- dosage-form

# Debug with UI
npm run test:forms:ui

# Manage disposable Supabase
npm run test:db:start
npm run test:db:seed
npm run test:db:status
npm run test:db:stop

# View report
npm run test:forms:report
```

> Supabase CLI + Docker required for disposable database workflow.

### Restore schema once

```bash
npm run test:db:start
# See docs/testing/RESTORE_YOUR_BACKUP.md for your specific backup
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres \
  < <(sed -n '152,$p' docs/archive/db_cluster-24-06-2025@06-59-13.backup)
npm run test:db:verify
```

## ðŸ”‘ Environment Setup

Create `.env.test.local` (auto-generated by `npm run test:db:start`):
```env
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGc...  # Auto-generated by Supabase CLI
SUPABASE_SERVICE_KEY=eyJhbGc...           # Auto-generated by Supabase CLI
TEST_GOAL_ID=56e2801e-0d78-4abd-a795-869e5b780ae7
TEST_USER_EMAIL=test@wwfm-platform.com
TEST_USER_PASSWORD=TestPassword123!
```

---

## ðŸš¨ Emergency Recovery

### "All tests failing after DB restore"

**Root cause**: Incomplete database restore (missing arenas/categories tables)

```bash
# 1. Verify what's missing
npm run test:db:verify

# 2. If arenas/categories are empty, restore COMPLETE dump
npm run test:db:stop
npm run test:db:start
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres \
  --set ON_ERROR_STOP=on \
  -f path/to/complete-dump.sql

# 3. Verify restore worked
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "
SELECT
  (SELECT COUNT(*) FROM arenas) as arenas,
  (SELECT COUNT(*) FROM categories) as categories,
  (SELECT COUNT(*) FROM goals WHERE id = '56e2801e-0d78-4abd-a795-869e5b780ae7') as test_goal;
"
# Expected: arenas=13, categories>0, test_goal=1

# 4. Seed test fixtures
npm run test:db:seed
```

### "Port 3000 conflicts"

```bash
# Nuclear option
pkill -9 -f "next dev"
lsof -ti:3000 | xargs kill -9
rm -rf .next

# Or use the verify script
npm run test:db:verify  # Kills servers automatically
```

### "Auth failures: missing email or phone"

**Root cause**: React hasn't hydrated when Playwright fills the form

**Fixed in**: `tests/setup/global-setup.ts` now waits for `networkidle` and verifies React state

**Manual fix if needed**:
```bash
# Confirm test user
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "
UPDATE auth.users
SET confirmed_at = NOW(), email_confirmed_at = NOW()
WHERE email = 'test@wwfm-platform.com';
"
```

### "404 on /goal/[id]/add-solution"

**Root cause**: Missing categories/arenas data (see "All tests failing" above)

**Why**: The page queries categories table at line 49-73 of `app/goal/[id]/add-solution/page.tsx`

### "Test fixtures not found"

```bash
# Re-seed fixtures
npm run test:db:seed

# Verify they exist
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "
SELECT COUNT(*) as fixtures
FROM solutions
WHERE source_type = 'test_fixture';
"
# Expected: 23
```

## ðŸ“ Key Files

- **Test Factory**: `/tests/e2e/forms/form-test-factory.ts`
- **Form Configs**: `/tests/e2e/forms/form-configs.ts`
- **Test Helpers**: `/tests/e2e/utils/test-helpers.ts`
- **Test Data**: `/tests/e2e/fixtures/test-data.ts`

## âœ… Testing Checklist

Before pushing:
- [ ] Run tests locally
- [ ] Check no hardcoded waits
- [ ] Verify cleanup works
- [ ] Update selectors if UI changed
- [ ] Add new tests for new features

## ðŸ› Debug Tips

1. **Can't find element**: Use `page.pause()` to inspect
2. **Timeout errors**: Increase timeout or check selectors
3. **Data not saved**: Check form validation errors
4. **Flaky tests**: Add proper waits, not `waitForTimeout`

## ðŸ“ Test Pattern

```typescript
test('form name: test description', async ({ page }) => {
  // Arrange
  const testData = generateTestSolution('category')
  
  // Act
  await page.goto(`/goal/${TEST_GOAL_ID}/add-solution`)
  // ... fill form
  
  // Assert
  const result = await verifyDataPipeline(testData.title, 'category')
  expect(result.success).toBe(true)
  
  // Cleanup
  await cleanupTestData(testData.title)
})
```

## ðŸŽ¯ Selectors Priority

1. `data-testid` attributes (best)
2. Role/label selectors
3. Text content
4. CSS selectors (avoid if possible)

## ðŸ”„ CI/CD

- Tests run on every PR
- Add GitHub secrets for deployment
- Check Actions tab for results
- Download artifacts for debugging

## ðŸ’¡ Pro Tips

- Use `test.only` for focused development
- Run `npx playwright codegen` to generate selectors
- Add `await page.screenshot()` for debugging
- Use `test.describe` to group related tests
- Keep tests independent - no shared state!

---

**Need help?** Check `/docs/testing/README.md` for full documentation.
